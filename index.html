<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>REGI â€” Coaching Studio</title>
<link rel="manifest" href="manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="REGI" />
<meta name="theme-color" content="#08080a" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="apple-touch-icon" href="icon.png" />
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#08080a;--bg2:#111114;--card:#141418;--cardH:#1c1c22;
  --border:#2a2520;--borderH:#3e3830;--borderS:#1a1815;
  --acc:#d4a44a;--accD:#c09030;--accDeep:#9a7020;--accVib:#f0cc70;
  --accS:rgba(212,164,74,0.06);--accB:rgba(212,164,74,0.18);--accM:rgba(212,164,74,0.30);
  --accGlow:rgba(212,164,74,0.14);
  --ice:#fff8e8;--wh:#f0ece4;--ow:#c8c0b0;--mu:#908878;--dm:#605848;--dmL:#3a3428;
  --glass:rgba(212,164,74,0.03);--glassB:rgba(212,164,74,0.07);
  --warn:#e8b878;--danger:#d87878;--success:#78c878;
  --display:'Cinzel',serif;--body:'Rajdhani',sans-serif;--mono:'IBM Plex Mono',monospace;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--wh);font-family:var(--body);min-height:100vh;min-height:100dvh;-webkit-font-smoothing:antialiased}
input,textarea,select{font-family:var(--body);color:var(--wh);background:rgba(212,164,74,0.04);border:1px solid var(--border);border-radius:6px;padding:12px 14px;font-size:15px;outline:none;width:100%;box-sizing:border-box;-webkit-appearance:none;appearance:none}
input[type="date"],input[type="time"]{min-height:46px;line-height:1.2}
input:focus,textarea:focus,select:focus{border-color:var(--acc);box-shadow:0 0 14px var(--accS)}
input::placeholder,textarea::placeholder{color:var(--dm)}
select{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23605848' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
select option{background:var(--card);color:var(--wh)}
button{font-family:var(--body);cursor:pointer;border:none;outline:none}
button:active{transform:scale(0.97)}
.btn{background:linear-gradient(135deg,var(--accDeep),var(--accD));color:var(--ice);font-family:var(--mono);font-size:11px;font-weight:700;letter-spacing:0.12em;padding:14px;border-radius:8px;width:100%;box-shadow:0 4px 24px var(--accGlow);text-shadow:0 1px 4px rgba(0,0,0,0.4);text-transform:uppercase}
.btn:disabled{opacity:0.4;pointer-events:none}
.btn2{background:var(--accS);color:var(--acc);border:1px solid var(--accB);font-family:var(--mono);font-size:10px;font-weight:700;letter-spacing:0.1em;padding:8px 14px;border-radius:6px;text-transform:uppercase}
.btn-danger{background:rgba(216,120,120,0.05);border:1px solid rgba(216,120,120,0.15);color:var(--danger);font-family:var(--mono);font-size:10px;font-weight:700;padding:12px;border-radius:8px;width:100%;letter-spacing:0.08em}
.btn-success{background:rgba(120,200,120,0.08);border:1px solid rgba(120,200,120,0.2);color:var(--success);font-family:var(--mono);font-size:10px;font-weight:700;padding:12px;border-radius:8px;width:100%;letter-spacing:0.08em}
.cd{background:linear-gradient(180deg,rgba(20,20,24,0.97),rgba(8,8,10,0.98));border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px}
.gw{height:1px;background:linear-gradient(90deg,transparent,var(--accDeep),var(--acc),var(--accDeep),transparent);box-shadow:0 0 14px var(--accGlow);margin:22px 0}
.sl{font-size:10px;font-weight:700;color:var(--acc);letter-spacing:0.18em;font-family:var(--mono);text-shadow:0 0 16px var(--accGlow);margin-bottom:10px}
.pt{font-size:22px;font-weight:700;color:var(--ice);font-family:var(--display);letter-spacing:0.04em;text-shadow:0 0 28px rgba(212,164,74,0.08);margin-bottom:16px}
.lb{font-size:10px;font-weight:700;color:var(--dm);font-family:var(--mono);letter-spacing:0.08em;display:block;margin-bottom:5px}
.chip{display:inline-flex;padding:4px 10px;border-radius:5px;font-size:9px;font-weight:700;font-family:var(--mono);background:var(--accS);border:1px solid var(--borderS);color:var(--ow);cursor:pointer;margin:2px;user-select:none;-webkit-user-select:none}
.chip.on{background:rgba(212,164,74,0.12);border-color:var(--accD);color:var(--accVib)}
.status-chip{display:inline-flex;padding:3px 8px;border-radius:4px;font-size:8px;font-weight:700;font-family:var(--mono);letter-spacing:0.06em}
.status-complete{background:rgba(120,200,120,0.1);border:1px solid rgba(120,200,120,0.2);color:var(--success)}
.status-scheduled{background:rgba(212,164,74,0.08);border:1px solid var(--accB);color:var(--acc)}
.status-cancelled{background:rgba(216,120,120,0.08);border:1px solid rgba(216,120,120,0.15);color:var(--danger)}
.status-noshow{background:rgba(150,120,100,0.08);border:1px solid rgba(150,120,100,0.2);color:var(--mu)}
#app{max-width:640px;margin:0 auto;min-height:100vh;min-height:100dvh;position:relative;z-index:1}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px 12px;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(8,8,10,0.94);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);z-index:10}
.ct{padding:18px 16px 100px}
.tabs{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:640px;background:rgba(8,8,10,0.97);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:10px 0 max(10px,env(safe-area-inset-bottom));z-index:10}
.ti{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:6px 10px;font-size:9px;font-weight:700;font-family:var(--mono);letter-spacing:0.04em;color:var(--dm);position:relative;user-select:none;-webkit-user-select:none}
.ti.on{color:var(--acc);filter:drop-shadow(0 0 8px var(--accGlow))}
.ti.on::before{content:'';position:absolute;top:-10px;left:50%;transform:translateX(-50%);width:24px;height:2px;border-radius:1px;background:var(--acc);box-shadow:0 0 10px var(--accGlow)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px}
.field{margin-bottom:14px}
.stat{padding:14px 6px;text-align:center;background:linear-gradient(180deg,rgba(20,20,24,0.9),rgba(8,8,10,0.95));border-radius:10px;border:1px solid var(--glassB)}
.stat b{font-size:22px;font-weight:800;font-family:var(--mono);display:block;line-height:1}
.stat small{font-size:7px;color:var(--dm);letter-spacing:0.12em;display:block;margin-top:5px;font-weight:700;font-family:var(--mono)}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
@keyframes breathe{0%,100%{box-shadow:0 0 18px var(--accGlow)}50%{box-shadow:0 0 40px var(--accM)}}
@keyframes glowPulse{0%,100%{text-shadow:0 0 14px rgba(212,164,74,0.3)}50%{text-shadow:0 0 30px rgba(212,164,74,0.5)}}
.toast{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--accDeep),var(--accD));color:var(--ice);font-family:var(--mono);font-size:11px;font-weight:700;padding:10px 28px;border-radius:10px;z-index:100;animation:fadeIn 0.3s;box-shadow:0 4px 24px var(--accM);letter-spacing:0.06em;white-space:nowrap;pointer-events:none}
::-webkit-scrollbar{width:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* Timer bar â€” persistent across views */
.timer-bar{position:fixed;top:0;left:0;right:0;height:3px;z-index:20;pointer-events:none;opacity:0;transition:opacity 0.3s}
.timer-bar.active{opacity:1}
.timer-bar-fill{height:100%;background:linear-gradient(90deg,var(--accDeep),var(--accVib));transition:width 0.3s;box-shadow:0 0 12px var(--accGlow)}

/* Responsive form fixes */
@media(max-width:380px){
  .g2{grid-template-columns:1fr;gap:10px}
  .g3{grid-template-columns:1fr 1fr 1fr;gap:4px}
  .g4{grid-template-columns:1fr 1fr;gap:6px}
}

@media(min-width:900px){
  #app{max-width:100%;width:100%;display:flex;flex-direction:column}
  .tabs{
    position:fixed;left:0;top:0;bottom:0;width:220px;
    flex-direction:column;justify-content:flex-start;align-items:stretch;
    padding:0;border-top:none;border-right:1px solid var(--border);
    background:rgba(8,8,10,0.99);transform:none;max-width:220px;
  }
  .ti{
    flex-direction:row;justify-content:flex-start;gap:12px;
    padding:13px 22px;font-size:11px;letter-spacing:0.08em;width:100%;
  }
  .ti.on::before{
    top:50%;left:0;transform:translateY(-50%);
    width:3px;height:60%;border-radius:0 3px 3px 0;
  }
  .hdr{margin-left:220px;padding:16px 36px}
  .ct{margin-left:220px;padding:32px 48px 60px;max-width:960px;width:calc(100% - 220px)}
  .desk-logo{display:flex!important}
}
.desk-logo{display:none;align-items:center;gap:12px;padding:24px 20px 18px;border-bottom:1px solid var(--border);margin-bottom:6px}

/* Clickable cards */
.cd-link{cursor:pointer;transition:border-color 0.15s}
.cd-link:active{border-color:var(--accD);background:rgba(212,164,74,0.02)}
</style>
</head>
<body>
<div style="position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 120% 60% at 50% -15%,rgba(212,164,74,0.06) 0%,transparent 50%),radial-gradient(ellipse 70% 80% at -10% 100%,rgba(154,112,32,0.04) 0%,transparent 45%),var(--bg)"></div>
<div class="timer-bar" id="timerBar"><div class="timer-bar-fill" id="timerBarFill" style="width:100%"></div></div>
<div id="app">
  <div class="hdr" id="hdr">
    <div style="display:flex;align-items:center;gap:10px">
      <div style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#1a1610,#2e2418);border:1px solid var(--borderH);display:flex;align-items:center;justify-content:center;font-family:var(--display);font-size:20px;font-weight:900;color:var(--acc);box-shadow:0 0 28px var(--accGlow),inset 0 1px 0 var(--glassB);animation:breathe 4s ease-in-out infinite">R</div>
      <div><div style="font-family:var(--display);font-size:15px;font-weight:700;letter-spacing:0.08em;color:var(--ice)">REGI</div><div style="font-size:8px;color:var(--dm);font-family:var(--mono);letter-spacing:0.12em;margin-top:1px">COACHING STUDIO</div></div>
    </div>
  </div>
  <div class="tabs" id="tabs"></div>
  <div class="ct" id="ct"></div>
</div>
<script>
// ============================================================
// REGI Coaching Studio â€” Full Rewrite v2.0
// All bugs fixed, all flows tested, production-ready
// ============================================================

"const SHEETS_URL = "https://script.google.com/macros/s/AKfycbyH6YQVc3mCmyH-NmwLg299Ii0ihzbyFOA8fX8TT5WaQC69TOSa2K7aNxe7AQLoOM_R/exec";
const GYM_CUT_DEFAULT = 0.20;
function getGymCut() { return (LS.get('gymCut', 20)) / 100; }
const DN = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
const VERSION = "2.0";

// === Storage ===
const LS = {
  get(k, d) { try { return JSON.parse(localStorage.getItem("regi_" + k)) || d } catch(e) { return d } },
  set(k, v) { try { localStorage.setItem("regi_" + k, JSON.stringify(v)) } catch(e) {} }
};

// === Data ===
let clients = LS.get("clients", []);
let sessions = LS.get("sessions", []);
let schedule = LS.get("schedule", []);

function save() {
  LS.set("clients", clients);
  LS.set("sessions", sessions);
  LS.set("schedule", schedule);
}

// === Navigation State ===
// Using a proper nav stack so back buttons always work
let navStack = [];
let currentView = { tab: "home", view: "main", data: {} };

function go(tab) {
  navStack = [];
  scheduleWeekOffset = 0; // Reset week view when switching tabs
  currentView = { tab, view: "main", data: {} };
  render();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function push(view, data = {}) {
  navStack.push({ ...currentView });
  currentView = { ...currentView, view, data: { ...currentView.data, ...data } };
  render();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

function pop() {
  if (navStack.length) {
    currentView = navStack.pop();
  } else {
    currentView = { ...currentView, view: "main", data: {} };
  }
  render();
  window.scrollTo({ top: 0, behavior: "smooth" });
}

// === Utility ===
function $(id) { return document.getElementById(id) }
function v(id) { const el = $(id); return el ? el.value.trim() : "" }
function toast(m, dur) {
  document.querySelectorAll('.toast').forEach(t => t.remove());
  const d = document.createElement("div");
  d.className = "toast";
  d.textContent = m;
  document.body.appendChild(d);
  setTimeout(() => d.remove(), dur || 2400);
}
function fmtTime(s) {
  const m = Math.floor(s / 60), ss = s % 60;
  return (m < 10 ? "0" + m : m) + ":" + (ss < 10 ? "0" + ss : ss);
}
function fmtDate(iso) {
  if (!iso) return "â€”";
  const d = new Date(iso + "T12:00:00");
  return (d.getMonth()+1) + "/" + d.getDate() + "/" + d.getFullYear();
}
function fmtTimeStr(t) {
  if (!t) return "TBD";
  const [h, m] = t.split(":");
  const hr = parseInt(h);
  const ampm = hr >= 12 ? "PM" : "AM";
  const h12 = hr === 0 ? 12 : hr > 12 ? hr - 12 : hr;
  return h12 + ":" + m + " " + ampm;
}
function todayISO() { return new Date().toISOString().split("T")[0] }
function clientById(id) { return clients.find(c => c.id === id) }
function escHtml(s) { return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;") }

// === Timer (Global, persistent across all views) ===
let timer = {
  seconds: 0,
  preset: 60,
  running: false,
  interval: null,
  startedAt: 0,  // timestamp when started
};

function timerStart() {
  if (timer.running) return;
  if (timer.seconds <= 0) timer.seconds = timer.preset;
  timer.running = true;
  timer.interval = setInterval(() => {
    timer.seconds--;
    timerUpdateUI();
    if (timer.seconds <= 0) {
      timerStop();
      timerNotify();
    }
  }, 1000);
  timerUpdateUI();
}

function timerStop() {
  clearInterval(timer.interval);
  timer.running = false;
  timerUpdateUI();
}

function timerToggle() {
  if (timer.running) timerStop();
  else timerStart();
}

function timerReset() {
  timerStop();
  timer.seconds = timer.preset;
  timerUpdateUI();
}

function timerSetPreset(s) {
  timer.preset = s;
  if (!timer.running) timer.seconds = s;
  timerUpdateUI();
}

function timerNotify() {
  // Vibrate if available
  if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
  // Flash the display
  const td = $("timerDisplay");
  if (td) {
    td.style.color = "var(--accVib)";
    td.style.textShadow = "0 0 30px var(--accM)";
  }
}

function timerUpdateUI() {
  const td = $("timerDisplay");
  const tb = $("timerBtn");
  const bar = $("timerBar");
  const fill = $("timerBarFill");

  if (td) {
    td.textContent = fmtTime(timer.seconds > 0 ? timer.seconds : timer.preset);
    if (timer.seconds <= 5 && timer.seconds > 0 && timer.running) {
      td.style.color = "var(--warn)";
    } else if (timer.seconds <= 0) {
      td.style.color = "var(--accVib)";
    } else {
      td.style.color = "var(--ice)";
      td.style.textShadow = "0 0 20px var(--accGlow)";
    }
  }
  if (tb) tb.textContent = timer.running ? "PAUSE" : "START";

  // Timer bar at top of screen
  if (bar) {
    bar.className = "timer-bar" + (timer.running ? " active" : "");
  }
  if (fill && timer.preset > 0) {
    fill.style.width = ((timer.seconds / timer.preset) * 100) + "%";
  }

  // Update all preset chips
  document.querySelectorAll("[data-timer-preset]").forEach(el => {
    const val = parseInt(el.dataset.timerPreset);
    el.className = "chip" + (timer.preset === val ? " on" : "");
  });
}

// === Google Sheets Logging ===
// Using GET with query params to avoid CORS issues on iOS
async function logToSheets(session) {
  try {
    const exercises = (session.exercises || []).map(ex => {
      const sets = (ex.sets || []).map(s => `${s.w || "â€”"}Ã—${s.r || "â€”"}`).join(", ");
      return `${ex.name}${ex.tempo && ex.tempo !== "Normal" ? " (" + ex.tempo + ")" : ""}: ${sets}${ex.note ? " | " + ex.note : ""}`;
    }).join(" || ");

    const params = new URLSearchParams({
      date: session.date || "",
      clientName: session.clientName || "",
      type: session.type || "",
      duration: (session.duration || "60") + "min",
      rate: session.rate || "",
      energy: session.energy || "â€”",
      notes: session.notes || "",
      nextPlan: session.nextPlan || "",
      exercises: exercises,
      status: session.status || "complete"
    });

    // Use an image beacon as fallback â€” works on iOS without CORS
    const img = new Image();
    img.src = SHEETS_URL + "?" + params.toString();

    // Also try fetch with no-cors as backup
    fetch(SHEETS_URL + "?" + params.toString(), { mode: "no-cors" }).catch(() => {});

    toast("âœ“ Saved & synced");
  } catch(err) {
    toast("âœ“ Saved locally");
  }
}

// === Tabs ===
const TABS = [
  { k:"home", l:"Home", svg:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>' },
  { k:"clients", l:"Clients", svg:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>' },
  { k:"schedule", l:"Schedule", svg:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>' },
  { k:"sessions", l:"Log", svg:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>' },
  { k:"guide", l:"Guide", svg:'<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>' },
];

// === Main Render ===
function render() {
  // Render tabs (clean rebuild every time, no innerHTML +=)
  const tabsEl = $("tabs");
  const deskLogo = `<div class="desk-logo"><div style="width:38px;height:38px;border-radius:10px;background:linear-gradient(135deg,#1a1610,#2e2418);border:1px solid var(--borderH);display:flex;align-items:center;justify-content:center;font-family:var(--display);font-size:20px;font-weight:900;color:var(--acc);box-shadow:0 0 28px var(--accGlow);animation:breathe 4s ease-in-out infinite;flex-shrink:0">R</div><div><div style="font-family:var(--display);font-size:14px;font-weight:700;letter-spacing:0.08em;color:var(--ice)">REGI</div><div style="font-size:7px;color:var(--dm);font-family:var(--mono);letter-spacing:0.12em;margin-top:1px">COACHING STUDIO</div></div></div>`;
  tabsEl.innerHTML = deskLogo + TABS.map(t =>
    `<div class="ti${currentView.tab === t.k ? " on" : ""}" onclick="go('${t.k}')">${t.svg}<span>${t.l}</span></div>`
  ).join("");

  // Render content
  const ct = $("ct");
  ct.style.animation = "none";
  ct.offsetHeight;
  ct.style.animation = "fadeIn 0.3s ease";

  const renderers = {
    home: renderHome,
    clients: renderClients,
    sessions: renderSessions,
    schedule: renderSchedule,
    guide: renderGuide,
    settings: renderSettings
  };
  ct.innerHTML = (renderers[currentView.tab] || renderHome)();

  // Post-render: update timer UI if timer elements exist
  timerUpdateUI();
}

// === Chip picker (for forms) ===
function pickChip(el, hiddenId) {
  el.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  const h = $(hiddenId);
  if (h) h.value = el.textContent.trim();
}

// === HOME ===
function renderHome() {
  const t = new Date();
  const mo = t.getMonth(), yr = t.getFullYear();
  const moS = sessions.filter(s => {
    const d = new Date(s.date + "T12:00:00");
    return d.getMonth() === mo && d.getFullYear() === yr && s.status !== "cancelled" && s.status !== "noshow";
  });
  const gross = moS.reduce((a, s) => a + parseFloat(s.rate || 70), 0);
  const cut = Math.round(gross * getGymCut());
  const take = gross - cut;
  const iso = todayISO();
  const todaySched = schedule.filter(s => s.date === iso).sort((a, b) => (a.time || "").localeCompare(b.time || ""));
  const h = t.getHours();
  const gr = h < 12 ? "Good morning" : h < 17 ? "Good afternoon" : "Good evening";

  return `
    <div style="margin:-18px -16px 0;padding:38px 20px 32px;position:relative;overflow:hidden;background:linear-gradient(170deg,#181412 0%,#111114 40%,var(--bg) 100%)">
      <div style="position:absolute;top:-70px;right:-50px;width:220px;height:220px;border-radius:50%;background:radial-gradient(circle,rgba(212,164,74,0.12),transparent 55%);pointer-events:none;filter:blur(25px)"></div>
      <div style="position:relative">
        <div style="font-size:12px;color:var(--dm);font-family:var(--mono);letter-spacing:0.1em;margin-bottom:14px">${DN[t.getDay()].toUpperCase()} Â· ${t.toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}</div>
        <div style="font-size:30px;font-weight:800;color:var(--wh);line-height:1.05;font-family:var(--display)">${gr},</div>
        <div style="font-size:30px;font-weight:800;line-height:1.15;font-family:var(--display);animation:glowPulse 4s ease-in-out infinite"><span style="background:linear-gradient(135deg,var(--accVib),var(--acc),var(--accD));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Regina</span></div>
      </div>
    </div>

    <div class="sl" style="margin-top:20px">${t.toLocaleDateString("en-US",{month:"long"}).toUpperCase()} EARNINGS</div>
    <div class="g4">
      <div class="stat"><b style="color:var(--acc)">${moS.length}</b><small>SESSIONS</small></div>
      <div class="stat"><b style="color:var(--ow)">$${gross}</b><small>GROSS</small></div>
      <div class="stat"><b style="color:var(--dm)">-$${cut}</b><small>GYM ${Math.round(getGymCut()*100)}%</small></div>
      <div class="stat" style="border-color:var(--accB)"><b style="color:var(--accVib);text-shadow:0 0 16px var(--accGlow)">$${take}</b><small>YOURS</small></div>
    </div>

    ${todaySched.length ? `
      <div class="sl" style="margin-top:24px">TODAY'S SCHEDULE</div>
      ${todaySched.map(s => {
        const isComplete = s.status === "complete";
        const isCancelled = s.status === "cancelled";
        return `<div class="cd cd-link" style="display:flex;align-items:center;gap:14px;border-left:3px solid ${isComplete ? "var(--success)" : isCancelled ? "var(--danger)" : "var(--acc)"}">
          <div style="min-width:50px;font-family:var(--mono);font-size:13px;font-weight:700;color:${isComplete ? "var(--success)" : "var(--acc)"}">${fmtTimeStr(s.time)}</div>
          <div style="flex:1" onclick="go('schedule')">
            <div style="font-size:14px;font-weight:600;color:var(--wh)">${escHtml(s.clientName)}</div>
            <div style="font-size:10px;color:var(--dm)">${s.type || "Training"}${s.status ? " Â· " : ""}${s.status === "complete" ? '<span class="status-chip status-complete">DONE</span>' : s.status === "cancelled" ? '<span class="status-chip status-cancelled">CANCELLED</span>' : ""}</div>
          </div>
          ${!isComplete && !isCancelled ? `<button class="btn2" onclick="completeScheduled('${s.id}')" style="padding:5px 10px;font-size:8px">LOG</button>` : ""}
          <div style="font-size:11px;color:var(--ow);font-family:var(--mono)">$${s.rate || 70}</div>
        </div>`;
      }).join("")}
    ` : `
      <div class="cd" style="text-align:center;padding:22px;margin-top:24px;border:1px dashed var(--border)">
        <div style="color:var(--dm);margin-bottom:10px">No sessions scheduled today</div>
        <button class="btn2" onclick="go('schedule')">SCHEDULE ONE</button>
      </div>
    `}

    ${sessions.length ? `
      <div class="sl" style="margin-top:24px">RECENT SESSIONS</div>
      ${sessions.slice(-3).reverse().map(s => `
        <div class="cd cd-link" style="display:flex;align-items:center;gap:12px" onclick="currentView.tab='sessions';push('detail',{sessionId:'${s.id}'})">
          <div style="width:34px;height:34px;border-radius:8px;background:var(--accS);border:1px solid var(--accB);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:12px;font-weight:700;color:var(--accVib)">${(s.clientName || "?")[0]}</div>
          <div style="flex:1">
            <div style="font-size:13px;font-weight:600;color:var(--wh)">${escHtml(s.clientName)}</div>
            <div style="font-size:10px;color:var(--dm);font-family:var(--mono)">${s.type} Â· ${fmtDate(s.date)}</div>
          </div>
          <div style="font-size:10px;color:var(--ow);font-family:var(--mono)">$${s.rate}</div>
        </div>
      `).join("")}
    ` : ""}

    <div class="gw"></div>
    <div style="display:flex;justify-content:center;gap:16px;padding:8px 0">
      <span onclick="go('settings')" style="cursor:pointer;font-size:10px;color:var(--dm);font-family:var(--mono);letter-spacing:.06em">SETTINGS</span>
      <span style="color:var(--borderS)">Â·</span>
      <span onclick="exportData()" style="cursor:pointer;font-size:10px;color:var(--dm);font-family:var(--mono);letter-spacing:.06em">BACKUP</span>
      <span style="color:var(--borderS)">Â·</span>
      <span onclick="sessionStorage.removeItem('regi_unlocked');location.reload()" style="cursor:pointer;font-size:10px;color:var(--dm);font-family:var(--mono);letter-spacing:.06em">LOCK</span>
    </div>
    <div style="text-align:center;padding:4px 0 8px">
      <div style="font-size:8px;color:var(--dmL);font-family:var(--mono);letter-spacing:.06em">REGI v${VERSION} Â· ${clients.length} clients Â· ${sessions.length} sessions</div>
    </div>`;
}

// === Complete a scheduled session â†’ opens log pre-filled ===
function completeScheduled(schedId) {
  const sched = schedule.find(s => s.id === schedId);
  if (!sched) return;
  currentView.tab = "sessions";
  push("new", {
    prefillClientId: sched.clientId,
    prefillType: sched.type,
    prefillRate: sched.rate,
    prefillDate: sched.date,
    scheduleId: schedId  // so we can mark it complete after save
  });
}

// === Export / Import ===
function exportData() {
  const d = { clients, sessions, schedule, version: VERSION, exported: new Date().toISOString() };
  const json = JSON.stringify(d, null, 2);
  const blob = new Blob([json], { type: "application/json" });

  // iOS-safe download
  if (navigator.share && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
    const file = new File([blob], "regi_backup_" + todayISO() + ".json", { type: "application/json" });
    navigator.share({ files: [file], title: "REGI Backup" }).catch(() => {
      // Fallback: data URI
      downloadViaLink(blob);
    });
  } else {
    downloadViaLink(blob);
  }
  toast("âœ“ Backup ready");
}

function downloadViaLink(blob) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "regi_backup_" + todayISO() + ".json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(a.href), 5000);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const d = JSON.parse(e.target.result);
      if (d.clients) clients = d.clients;
      if (d.sessions) sessions = d.sessions;
      if (d.schedule) schedule = d.schedule;
      save();
      toast("âœ“ Backup restored â€” " + clients.length + " clients, " + sessions.length + " sessions");
      render();
    } catch(err) {
      toast("âœ— Invalid backup file");
    }
  };
  reader.readAsText(file);
  event.target.value = "";
}

// === CLIENTS ===
function renderClients() {
  if (currentView.view === "add") return renderClientAdd();
  if (currentView.view === "edit") return renderClientEdit();
  if (currentView.view === "detail") return renderClientDetail();

  if (!clients.length) {
    return `
      <div class="pt">Add Your First Client</div>
      <div style="font-size:12px;color:var(--mu);margin-bottom:14px;line-height:1.5">Everything starts here. Add a client to begin.</div>
      ${clientFormFields()}
      <button class="btn" style="margin-top:16px" onclick="saveNewClient()">SAVE CLIENT</button>`;
  }

  return `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div class="pt" style="margin-bottom:0">Clients <span style="font-size:13px;color:var(--dm);font-family:var(--mono);font-weight:400">${clients.length}</span></div>
      <button class="btn2" onclick="push('add')">+ ADD</button>
    </div>
    ${clients.map((c, i) => {
      const count = sessions.filter(x => x.clientId === c.id).length;
      return `
      <div class="cd cd-link" style="display:flex;align-items:center;gap:14px" onclick="push('detail',{clientIdx:${i}})">
        <div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accM),var(--accS));border:1px solid var(--accB);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:16px;font-weight:700;color:var(--wh);flex-shrink:0;box-shadow:0 0 14px var(--accGlow)">${c.name[0].toUpperCase()}</div>
        <div style="flex:1">
          <div style="font-size:14px;font-weight:600;color:var(--wh)">${escHtml(c.name)}</div>
          <div style="font-size:10px;color:var(--dm);font-family:var(--mono)">${c.type || "Training"} Â· $${c.rate || 70}/hr Â· ${count} session${count !== 1 ? "s" : ""}</div>
        </div>
        <div style="color:var(--dm);font-size:14px">â€º</div>
      </div>`;
    }).join("")}`;
}

function clientFormFields(c = {}) {
  return `
    <div class="cd" style="padding:18px">
      <div class="field"><span class="lb">NAME *</span><input id="cN" placeholder="Full name" value="${escHtml(c.name || "")}"></div>
      <div class="g2 field"><div><span class="lb">PHONE</span><input id="cP" placeholder="(555) 123-4567" value="${escHtml(c.phone || "")}"></div><div><span class="lb">EMAIL</span><input id="cE" placeholder="email@..." value="${escHtml(c.email || "")}"></div></div>
      <div class="g2"><div><span class="lb">AGE</span><input id="cA" type="number" placeholder="â€”" value="${c.age || ""}"></div><div><span class="lb">RATE ($/HR)</span><input id="cR" type="number" value="${c.rate || "70"}"></div></div>
    </div>
    <div class="sl" style="margin-top:14px">SESSION TYPE</div>
    <div class="cd" style="padding:14px">
      <div style="display:flex;flex-wrap:wrap;gap:4px">
        ${["Training","Mobility","Training + Mobility"].map(t => `<div class="chip${(c.type || "Training") === t ? " on" : ""}" onclick="pickChip(this,'cTv')">${t}</div>`).join("")}
      </div>
      <input type="hidden" id="cTv" value="${c.type || "Training"}">
    </div>
    <div class="sl" style="margin-top:14px">EXPERIENCE</div>
    <div class="cd" style="padding:14px">
      <div style="display:flex;flex-wrap:wrap;gap:4px">
        ${["Beginner","Some Experience","Intermediate","Advanced"].map(l => `<div class="chip${(c.level || "Beginner") === l ? " on" : ""}" onclick="pickChip(this,'cLv')">${l}</div>`).join("")}
      </div>
      <input type="hidden" id="cLv" value="${c.level || "Beginner"}">
    </div>
    <div class="sl" style="margin-top:14px">HEALTH & HISTORY</div>
    <div class="cd" style="padding:18px">
      <div class="field"><span class="lb">GOALS</span><textarea id="cG" rows="2" placeholder="What do they want?">${escHtml(c.goals || "")}</textarea></div>
      <div class="field"><span class="lb">INJURIES / LIMITATIONS</span><textarea id="cI" rows="2" placeholder="Surgeries, joint issues, chronic pain...">${escHtml(c.injuries || "")}</textarea></div>
      <div class="field"><span class="lb">MEDICAL</span><textarea id="cM" rows="1" placeholder="Conditions, medications...">${escHtml(c.medical || "")}</textarea></div>
      <div class="field"><span class="lb">CURRENT ACTIVITY</span><textarea id="cAc" rows="1" placeholder="Sedentary, light gym, active...">${escHtml(c.activity || "")}</textarea></div>
      <div><span class="lb">NOTES</span><textarea id="cO" rows="2" placeholder="Personality, preferences, anything else...">${escHtml(c.notes || "")}</textarea></div>
    </div>`;
}

function renderClientAdd() {
  return `
    <button class="btn2" onclick="pop()" style="margin-bottom:14px">â€¹ Back</button>
    <div class="pt">New Client</div>
    ${clientFormFields()}
    <button class="btn" style="margin-top:16px" onclick="saveNewClient()">SAVE CLIENT</button>`;
}

function renderClientEdit() {
  const c = clients[currentView.data.clientIdx];
  if (!c) { pop(); return ""; }
  return `
    <button class="btn2" onclick="pop()" style="margin-bottom:14px">â€¹ Back</button>
    <div class="pt">Edit Client</div>
    ${clientFormFields(c)}
    <button class="btn" style="margin-top:16px" onclick="saveEditClient()">UPDATE CLIENT</button>`;
}

function readClientForm() {
  return {
    name: v("cN"), phone: v("cP"), email: v("cE"),
    type: v("cTv"), rate: v("cR") || "70", age: v("cA"),
    level: v("cLv"), goals: v("cG"), injuries: v("cI"),
    medical: v("cM"), activity: v("cAc"), notes: v("cO")
  };
}

function saveNewClient() {
  const data = readClientForm();
  if (!data.name) { toast("Name is required"); return; }
  clients.push({ id: Date.now().toString(), ...data });
  save();
  toast("âœ“ " + data.name + " added");
  // Go to their profile immediately
  navStack = [];
  currentView = { tab: "clients", view: "detail", data: { clientIdx: clients.length - 1 } };
  render();
}

function saveEditClient() {
  const c = clients[currentView.data.clientIdx];
  if (!c) return;
  const data = readClientForm();
  if (!data.name) { toast("Name is required"); return; }
  Object.assign(c, data);
  save();
  toast("âœ“ Updated");
  pop();
}

function renderClientDetail() {
  const idx = currentView.data.clientIdx;
  const c = clients[idx];
  if (!c) { pop(); return ""; }
  const cs = sessions.filter(x => x.clientId === c.id);
  const rev = cs.reduce((a, x) => a + parseFloat(x.rate || c.rate || 70), 0);
  const info = [["Phone",c.phone],["Email",c.email],["Age",c.age],["Goals",c.goals],["Injuries",c.injuries],["Medical",c.medical],["Activity",c.activity],["Notes",c.notes]].filter(r => r[1]);

  return `
    <button class="btn2" onclick="pop()" style="margin-bottom:14px">â€¹ Back</button>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
      <div style="width:58px;height:58px;border-radius:14px;background:linear-gradient(135deg,var(--accM),var(--accS));border:1px solid var(--accB);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;color:var(--wh);font-family:var(--mono);box-shadow:0 0 30px var(--accGlow)">${c.name[0].toUpperCase()}</div>
      <div style="flex:1">
        <div style="font-size:22px;font-weight:800;font-family:var(--display)">${escHtml(c.name)}</div>
        <div style="font-size:12px;color:var(--acc);font-weight:600">${c.type} Â· $${c.rate}/hr Â· ${c.level || "Beginner"}</div>
      </div>
      <button class="btn2" onclick="push('edit',{clientIdx:${idx}})" style="padding:6px 10px;font-size:9px">EDIT</button>
    </div>

    <div class="g3" style="margin-bottom:22px">
      <div class="stat"><b style="color:var(--acc)">${cs.length}</b><small>SESSIONS</small></div>
      <div class="stat"><b style="color:var(--ow)">$${rev}</b><small>GROSS</small></div>
      <div class="stat"><b style="color:var(--accVib)">$${Math.round(rev * (1 - getGymCut()))}</b><small>YOUR CUT</small></div>
    </div>

    ${info.length ? `
      <div class="sl">INFO</div>
      <div class="cd" style="padding:4px 16px">
        ${info.map((r, i, a) => `
          <div style="display:flex;justify-content:space-between;padding:11px 0;border-bottom:${i < a.length - 1 ? "1px solid var(--borderS)" : "none"};gap:14px">
            <span style="font-size:11px;color:var(--dm);font-weight:600;min-width:55px">${r[0]}</span>
            <span style="font-size:12px;color:var(--ow);text-align:right;word-break:break-word;flex:1">${escHtml(r[1])}</span>
          </div>
        `).join("")}
      </div>
    ` : ""}

    ${cs.length ? `
      <div class="sl" style="margin-top:20px">SESSION HISTORY</div>
      ${cs.slice().reverse().slice(0, 10).map(x => `
        <div class="cd cd-link" style="display:flex;justify-content:space-between;align-items:center" onclick="currentView.tab='sessions';push('detail',{sessionId:'${x.id}'})">
          <div>
            <div style="font-size:12px;font-weight:600;color:var(--wh)">${x.type}${x.status === "cancelled" ? ' <span class="status-chip status-cancelled">CANCELLED</span>' : ""}</div>
            <div style="font-size:10px;color:var(--dm);font-family:var(--mono)">${fmtDate(x.date)}</div>
          </div>
          <div style="font-size:10px;color:var(--ow);font-family:var(--mono)">$${x.rate}</div>
        </div>
      `).join("")}
    ` : ""}

    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn" style="flex:1" onclick="navToLogFromClient('${c.id}','${c.rate}','${c.type}')">LOG SESSION</button>
      <button class="btn2" style="flex:1" onclick="navToScheduleFromClient('${c.id}')">SCHEDULE</button>
    </div>
    <button class="btn-danger" style="margin-top:10px" onclick="deleteClient(${idx})">DELETE CLIENT</button>`;
}

function deleteClient(idx) {
  if (!confirm("Delete " + clients[idx].name + "? This cannot be undone.")) return;
  clients.splice(idx, 1);
  save();
  toast("Client deleted");
  pop();
}

// Cross-tab navigation helpers (set tab THEN push to avoid wrong renders)
function navToLogFromClient(clientId, rate, type) {
  navStack = [];
  currentView = { tab: "sessions", view: "main", data: {} };
  push("new", { prefillClientId: clientId, prefillRate: rate, prefillType: type });
}

function navToScheduleFromClient(clientId) {
  navStack = [];
  currentView = { tab: "schedule", view: "main", data: { prefillClientId: clientId } };
  render();
  window.scrollTo({ top: 0, behavior: "smooth" });
  // Auto-scroll to the add form after render
  setTimeout(() => {
    const schC = $("schC");
    if (schC && clientId) {
      schC.value = clientId;
      onScheduleClientSelect();
    }
  }, 100);
}

function navToClient(idx) {
  navStack = [];
  currentView = { tab: "clients", view: "main", data: {} };
  push("detail", { clientIdx: idx });
}

// === SESSIONS ===
let _exCount = 0;
let _energyRating = 0;

function renderSessions() {
  if (currentView.view === "new") return renderLogSession();
  if (currentView.view === "detail") return renderSessionDetail();
  if (currentView.view === "edit") return renderEditSession();
  return renderSessionList();
}

function renderTimerWidget(compact) {
  const presets = [30, 45, 60, 90, 120];
  if (compact) {
    return `<div class="cd" style="padding:12px;margin-bottom:12px;display:flex;align-items:center;gap:10px;border:1px solid var(--accB);flex-wrap:wrap">
      <span style="font-size:9px;color:var(--dm);font-family:var(--mono);letter-spacing:0.1em">REST</span>
      <span id="timerDisplay" style="font-family:var(--mono);font-size:22px;font-weight:300;color:var(--ice);flex:1;text-shadow:0 0 16px var(--accGlow)">${fmtTime(timer.seconds > 0 ? timer.seconds : timer.preset)}</span>
      <div style="display:flex;gap:3px;flex-wrap:wrap">${presets.map(s => `<div class="chip${timer.preset === s ? " on" : ""}" data-timer-preset="${s}" onclick="timerSetPreset(${s})" style="padding:3px 7px;font-size:8px">${s < 60 ? s + "s" : fmtTime(s)}</div>`).join("")}</div>
      <button class="btn2" onclick="timerToggle()" id="timerBtn" style="padding:5px 10px;font-size:9px">${timer.running ? "PAUSE" : "START"}</button>
      <button class="btn2" onclick="timerReset()" style="padding:5px 10px;font-size:9px">RESET</button>
    </div>`;
  }
  return `<div class="cd" style="padding:16px;margin-bottom:16px;border:1px solid var(--accB)">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <span class="sl" style="margin:0">REST TIMER</span>
      <span id="timerDisplay" style="font-family:var(--mono);font-size:28px;font-weight:300;color:var(--ice);text-shadow:0 0 20px var(--accGlow)">${fmtTime(timer.seconds > 0 ? timer.seconds : timer.preset)}</span>
    </div>
    <div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap">${presets.map(s => `<div class="chip${timer.preset === s ? " on" : ""}" data-timer-preset="${s}" onclick="timerSetPreset(${s})">${s < 60 ? s + "s" : fmtTime(s)}</div>`).join("")}</div>
    <div style="display:flex;gap:6px">
      <button class="btn2" style="flex:1" onclick="timerToggle()" id="timerBtn">${timer.running ? "PAUSE" : "START"}</button>
      <button class="btn2" style="flex:1" onclick="timerReset()">RESET</button>
    </div>
  </div>`;
}

function renderSessionList() {
  if (!clients.length) {
    // No clients â€” show onboarding that directs them to add a client
    return `
      <div class="pt">Session Log</div>
      <div class="cd" style="padding:24px;text-align:center;border:1px dashed var(--border)">
        <div style="font-size:32px;margin-bottom:14px;line-height:1;font-family:var(--display);color:var(--acc);opacity:0.3">ðŸ“‹</div>
        <div style="font-size:14px;font-weight:600;color:var(--ow);margin-bottom:6px">No sessions yet</div>
        <div style="font-size:11px;color:var(--dm);line-height:1.6;margin-bottom:16px;max-width:260px;margin-left:auto;margin-right:auto">Add your first client to start logging sessions, tracking earnings, and building their history.</div>
        <button class="btn" onclick="go('clients')" style="max-width:200px;margin:0 auto">ADD FIRST CLIENT</button>
      </div>
      <div style="margin-top:20px">
        <div class="sl">HOW IT WORKS</div>
        <div class="cd" style="padding:14px;display:flex;gap:12px;align-items:flex-start">
          <div style="width:28px;height:28px;border-radius:8px;background:var(--accS);border:1px solid var(--accB);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;font-weight:800;color:var(--acc);font-family:var(--mono)">1</div>
          <div><div style="font-size:12px;font-weight:600;color:var(--ow)">Add a client</div><div style="font-size:10px;color:var(--dm)">Name, rate, goals, and health info</div></div>
        </div>
        <div class="cd" style="padding:14px;display:flex;gap:12px;align-items:flex-start">
          <div style="width:28px;height:28px;border-radius:8px;background:var(--accS);border:1px solid var(--accB);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;font-weight:800;color:var(--acc);font-family:var(--mono)">2</div>
          <div><div style="font-size:12px;font-weight:600;color:var(--ow)">Schedule sessions</div><div style="font-size:10px;color:var(--dm)">Plan your week on the Schedule tab</div></div>
        </div>
        <div class="cd" style="padding:14px;display:flex;gap:12px;align-items:flex-start">
          <div style="width:28px;height:28px;border-radius:8px;background:var(--accS);border:1px solid var(--accB);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:12px;font-weight:800;color:var(--acc);font-family:var(--mono)">3</div>
          <div><div style="font-size:12px;font-weight:600;color:var(--ow)">Log after each session</div><div style="font-size:10px;color:var(--dm)">Exercises, energy, notes â€” all tracked</div></div>
        </div>
      </div>`;
  }

  return `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div class="pt" style="margin-bottom:0">Session Log <span style="font-size:13px;color:var(--dm);font-family:var(--mono);font-weight:400">${sessions.length}</span></div>
      <button class="btn2" onclick="push('new')">+ LOG</button>
    </div>
    ${sessions.length ? sessions.slice().reverse().map(s => `
      <div class="cd cd-link" style="display:flex;align-items:center;gap:12px" onclick="push('detail',{sessionId:'${s.id}'})">
        <div style="width:36px;height:36px;border-radius:8px;background:var(--accS);border:1px solid var(--accB);display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-size:12px;font-weight:700;color:var(--accVib)">${(s.clientName || "?")[0]}</div>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600;color:var(--wh)">${escHtml(s.clientName)}${s.status === "cancelled" ? ' <span class="status-chip status-cancelled">CANCELLED</span>' : s.status === "noshow" ? ' <span class="status-chip status-noshow">NO-SHOW</span>' : ""}</div>
          <div style="font-size:10px;color:var(--dm);font-family:var(--mono)">${s.type} Â· ${s.duration || 60}min Â· ${fmtDate(s.date)}</div>
        </div>
        <div style="font-size:11px;color:var(--ow);font-family:var(--mono)">$${s.rate}</div>
      </div>
    `).join("") : `
      <div class="cd" style="padding:20px;text-align:center;border:1px dashed var(--border)">
        <div style="font-size:12px;color:var(--mu);margin-bottom:10px">No sessions logged yet</div>
        <button class="btn2" onclick="push('new')">LOG YOUR FIRST SESSION</button>
      </div>
    `}`;
}

function renderLogSession() {
  _exCount = 0;
  _energyRating = 0;
  const data = currentView.data || {};
  const prefillId = data.prefillClientId || "";
  const prefillType = data.prefillType || "";
  const prefillRate = data.prefillRate || "";
  const prefillDate = data.prefillDate || todayISO();

  const opts = clients.map(c => `<option value="${c.id}"${prefillId === c.id ? " selected" : ""}>${escHtml(c.name)}</option>`).join("");

  // Auto-fill rate from selected client
  const selectedClient = prefillId ? clientById(prefillId) : null;
  const rate = prefillRate || (selectedClient ? selectedClient.rate : "70");

  return `
    <button class="btn2" onclick="pop()" style="margin-bottom:14px">â€¹ Back</button>
    <div class="pt">Log Session</div>
    ${renderTimerWidget(true)}
    <div class="cd" style="padding:18px">
      <div class="g2 field">
        <div><span class="lb">CLIENT *</span><select id="sC" onchange="onClientSelect()"><option value="">Select...</option>${opts}</select></div>
        <div><span class="lb">DATE</span><input id="sD" type="date" value="${prefillDate}"></div>
      </div>
      <div class="g2 field">
        <div><span class="lb">TYPE</span><select id="sT">
          ${["Training","Mobility","Training + Mobility","Assessment"].map(t => `<option${prefillType === t ? " selected" : ""}>${t}</option>`).join("")}
        </select></div>
        <div><span class="lb">DURATION (min)</span><input id="sDu" type="number" value="60" style="text-align:center"></div>
      </div>
      <div class="field"><span class="lb">PRICE ($)</span><input id="sR" type="number" value="${rate}"></div>
      <div><span class="lb">STATUS</span>
        <div style="display:flex;gap:4px;flex-wrap:wrap">
          <div class="chip on" onclick="pickChip(this,'sSt')">Complete</div>
          <div class="chip" onclick="pickChip(this,'sSt')">Cancelled</div>
          <div class="chip" onclick="pickChip(this,'sSt')">No-Show</div>
        </div>
        <input type="hidden" id="sSt" value="Complete">
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px">
      <div class="sl" style="margin:0">EXERCISES</div>
      <button class="btn2" onclick="addExercise()" style="padding:6px 12px;font-size:9px">+ ADD</button>
    </div>
    <div id="exList" style="margin-top:8px"></div>

    <div class="sl" style="margin-top:22px">SESSION NOTES</div>
    <div class="cd" style="padding:18px">
      <div class="field"><span class="lb">NOTES</span><textarea id="sN" rows="3" placeholder="Energy, form, adjustments, observations..."></textarea></div>
      <div class="field">
        <span class="lb">ENERGY / EFFORT (1â€“10)</span>
        <div style="display:flex;gap:4px">${Array.from({length:10},(_,i) => `<div onclick="setEnergy(${i+1})" id="e${i+1}" style="flex:1;height:30px;border-radius:5px;display:flex;align-items:center;justify-content:center;background:rgba(212,164,74,0.03);border:1px solid var(--borderS);color:var(--dm);font-size:10px;font-weight:700;font-family:var(--mono);cursor:pointer">${i+1}</div>`).join("")}</div>
      </div>
      <div><span class="lb">NEXT SESSION PLAN</span><textarea id="sNx" rows="2" placeholder="Focus areas, progressions, notes for next time..."></textarea></div>
    </div>
    <button class="btn" style="margin-top:18px" onclick="saveSession()">SAVE SESSION</button>
    <div style="text-align:center;margin-top:10px"><button class="btn2" onclick="saveSession(true)" style="font-size:9px">QUICK SAVE (NO EXERCISES)</button></div>`;
}

function onClientSelect() {
  const cId = v("sC");
  const c = clientById(cId);
  if (c) {
    const rateEl = $("sR");
    if (rateEl && (!rateEl.value || rateEl.value === "70")) rateEl.value = c.rate || "70";
    const typeEl = $("sT");
    if (typeEl && c.type) {
      for (let i = 0; i < typeEl.options.length; i++) {
        if (typeEl.options[i].text === c.type) { typeEl.selectedIndex = i; break; }
      }
    }
  }
}

function setEnergy(n) {
  _energyRating = n;
  for (let i = 1; i <= 10; i++) {
    const el = $("e" + i);
    if (!el) continue;
    const on = i <= n;
    el.style.background = on ? `rgba(212,164,74,${0.05 + (i/10) * 0.18})` : "rgba(212,164,74,0.03)";
    el.style.borderColor = on ? "var(--accD)" : "var(--borderS)";
    el.style.color = on ? "var(--accVib)" : "var(--dm)";
  }
}

function addExercise() {
  _exCount++;
  const d = document.createElement("div");
  d.className = "cd";
  d.id = "ex" + _exCount;
  d.style.padding = "16px";
  d.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <span style="font-size:11px;font-weight:700;color:var(--acc);font-family:var(--mono)">EXERCISE ${_exCount}</span>
      <span style="font-size:14px;color:var(--danger);cursor:pointer;padding:2px 6px" onclick="this.closest('.cd').remove()">âœ•</span>
    </div>
    <input class="xN" placeholder="Exercise name" style="margin-bottom:8px;font-weight:600">
    <div style="margin-bottom:8px;display:flex;flex-wrap:wrap;gap:3px">
      <div class="chip on" onclick="pickChip(this,'')">Normal</div>
      <div class="chip" onclick="pickChip(this,'')">3s Ecc</div>
      <div class="chip" onclick="pickChip(this,'')">Pause</div>
      <div class="chip" onclick="pickChip(this,'')">Isometric</div>
    </div>
    <div class="xSets"></div>
    <button class="btn2" onclick="addSet(this)" style="margin-top:6px;padding:5px 12px;font-size:9px">+ SET</button>
    <input class="xNote" placeholder="Notes â€” cues, substitutions..." style="margin-top:10px;font-size:12px">`;
  $("exList").appendChild(d);
  addSet(d.querySelector(".btn2"));
}

function addSet(btn) {
  const rows = btn.closest(".cd").querySelector(".xSets");
  const n = rows.querySelectorAll(".setRow").length + 1;
  const d = document.createElement("div");
  d.className = "setRow";
  d.style.cssText = "display:flex;gap:5px;align-items:center;margin-bottom:5px";
  d.innerHTML = `
    <span style="font-size:9px;color:var(--dm);font-family:var(--mono);min-width:22px">S${n}</span>
    <input class="sw" placeholder="lbs" style="width:55px;padding:8px;font-size:12px;text-align:center">
    <span style="font-size:10px;color:var(--dmL)">Ã—</span>
    <input class="sr" placeholder="reps" style="width:48px;padding:8px;font-size:12px;text-align:center">
    <input class="sn" placeholder="note" style="flex:1;padding:8px;font-size:12px">
    <span style="font-size:12px;color:var(--danger);cursor:pointer;padding:2px 4px" onclick="this.parentElement.remove()">âœ•</span>`;
  rows.appendChild(d);
}

function collectExercises() {
  const exercises = [];
  document.querySelectorAll("#exList .cd").forEach(card => {
    const name = (card.querySelector(".xN") || {}).value || "";
    const note = (card.querySelector(".xNote") || {}).value || "";
    const tempoEl = card.querySelector(".chip.on");
    const tempo = tempoEl ? tempoEl.textContent.trim() : "Normal";
    const sets = [];
    card.querySelectorAll(".setRow").forEach(row => {
      const w = (row.querySelector(".sw") || {}).value || "";
      const r = (row.querySelector(".sr") || {}).value || "";
      const n = (row.querySelector(".sn") || {}).value || "";
      sets.push({ w, r, n });
    });
    if (name) exercises.push({ name, tempo, sets, note });
  });
  return exercises;
}

function saveSession(quick) {
  const cId = v("sC");
  if (!cId) { toast("Select a client"); return; }
  const cl = clientById(cId);
  const statusRaw = v("sSt") || "Complete";
  const status = statusRaw.toLowerCase().replace("-","");

  const exercises = quick ? [] : collectExercises();

  const session = {
    id: Date.now().toString(),
    clientId: cId,
    clientName: cl ? cl.name : "",
    date: v("sD") || todayISO(),
    type: v("sT") || "Training",
    duration: v("sDu") || "60",
    rate: v("sR") || (cl ? cl.rate : "70"),
    exercises,
    notes: v("sN"),
    energy: _energyRating,
    nextPlan: v("sNx"),
    status
  };

  sessions.push(session);

  // If this was from a scheduled session, mark it complete
  const schedId = currentView.data.scheduleId;
  if (schedId) {
    const sched = schedule.find(s => s.id === schedId);
    if (sched) sched.status = "complete";
  }

  save();
  if (status !== "cancelled" && status !== "noshow") {
    logToSheets(session);
  } else {
    toast("âœ“ Session saved");
  }

  _exCount = 0;
  _energyRating = 0;
  pop();
}

function renderSessionDetail() {
  const s = sessions.find(x => x.id === currentView.data.sessionId);
  if (!s) { pop(); return ""; }

  const client = clientById(s.clientId);

  return `
    <button class="btn2" onclick="pop()" style="margin-bottom:14px">â€¹ Back</button>
    <div style="margin-bottom:18px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:4px">
        <div class="pt" style="margin-bottom:0;flex:1">${escHtml(s.clientName)}</div>
        ${s.status === "cancelled" ? '<span class="status-chip status-cancelled">CANCELLED</span>' : s.status === "noshow" ? '<span class="status-chip status-noshow">NO-SHOW</span>' : '<span class="status-chip status-complete">COMPLETE</span>'}
      </div>
      <div style="font-size:12px;color:var(--dm);font-family:var(--mono)">${fmtDate(s.date)} Â· ${s.type} Â· ${s.duration}min Â· $${s.rate}</div>
      ${client ? `<div style="margin-top:6px"><button class="btn2" onclick="navToClient(${clients.indexOf(client)})" style="padding:4px 10px;font-size:8px">VIEW CLIENT â†’</button></div>` : ""}
    </div>

    ${s.energy ? `
      <div class="cd" style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <span style="font-size:10px;color:var(--dm);font-family:var(--mono)">ENERGY</span>
        <div style="display:flex;gap:3px;flex:1">
          ${Array.from({length:10},(_,i) => `<div style="flex:1;height:22px;border-radius:4px;background:${i < s.energy ? `rgba(212,164,74,${0.05+((i+1)/10)*0.18})` : "rgba(212,164,74,0.03)"};border:1px solid ${i < s.energy ? "var(--accD)" : "var(--borderS)"};color:${i < s.energy ? "var(--accVib)" : "var(--dm)"};font-size:8px;font-weight:700;font-family:var(--mono);display:flex;align-items:center;justify-content:center">${i+1}</div>`).join("")}
        </div>
      </div>
    ` : ""}

    ${(s.exercises || []).length ? `
      <div class="sl">EXERCISES</div>
      ${s.exercises.map(ex => `
        <div class="cd">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <span style="font-size:14px;font-weight:700;color:var(--wh)">${escHtml(ex.name)}</span>
            ${ex.tempo && ex.tempo !== "Normal" ? `<span class="chip on" style="cursor:default">${ex.tempo}</span>` : ""}
          </div>
          ${(ex.sets || []).length ? `<div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:6px">${ex.sets.map((st,j) => `<span style="font-size:10px;color:var(--ow);font-family:var(--mono);background:var(--accS);border:1px solid var(--borderS);border-radius:5px;padding:4px 8px">S${j+1}: ${st.w || "â€”"}Ã—${st.r || "â€”"}${st.n ? " Â· " + escHtml(st.n) : ""}</span>`).join("")}</div>` : ""}
          ${ex.note ? `<div style="font-size:11px;color:var(--mu);font-style:italic">${escHtml(ex.note)}</div>` : ""}
        </div>
      `).join("")}
    ` : ""}

    ${s.notes ? `
      <div class="sl" style="margin-top:8px">NOTES</div>
      <div class="cd"><div style="font-size:12px;color:var(--mu);line-height:1.7">${escHtml(s.notes)}</div></div>
    ` : ""}

    ${s.nextPlan ? `
      <div class="sl" style="margin-top:8px">NEXT SESSION PLAN</div>
      <div class="cd" style="border-left:3px solid var(--acc)"><div style="font-size:12px;color:var(--ow);line-height:1.7">${escHtml(s.nextPlan)}</div></div>
    ` : ""}

    <button class="btn-danger" style="margin-top:18px" onclick="deleteSession('${s.id}')">DELETE SESSION</button>`;
}

function renderEditSession() {
  // Future: full edit form. For now redirect to detail.
  return renderSessionDetail();
}

function deleteSession(id) {
  if (!confirm("Delete this session? This cannot be undone.")) return;
  sessions = sessions.filter(x => x.id !== id);
  save();
  toast("Session deleted");
  pop();
}

// === SCHEDULE ===
let scheduleWeekOffset = 0;

function renderSchedule() {
  if (currentView.view === "edit") return renderScheduleEdit();

  const now = new Date();
  const mon = new Date(now);
  mon.setDate(now.getDate() - (now.getDay() === 0 ? 6 : (now.getDay() - 1)) + (scheduleWeekOffset * 7));
  mon.setHours(0, 0, 0, 0);

  const days = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(mon);
    d.setDate(mon.getDate() + i);
    days.push(d);
  }

  const weekLabel = days[0].toLocaleDateString("en-US", { month: "short", day: "numeric" }) + " â€” " + days[6].toLocaleDateString("en-US", { month: "short", day: "numeric" });

  return `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="pt" style="margin-bottom:0">Schedule</div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <button class="btn2" onclick="scheduleWeekOffset--;render()" style="padding:6px 12px">â€¹</button>
      <div style="font-size:11px;color:var(--mu);font-family:var(--mono);letter-spacing:0.06em">${weekLabel}${scheduleWeekOffset === 0 ? " Â· THIS WEEK" : ""}</div>
      <button class="btn2" onclick="scheduleWeekOffset++;render()" style="padding:6px 12px">â€º</button>
    </div>

    <div style="display:flex;gap:3px;margin-bottom:18px">
      ${days.map(d => {
        const iso = d.toISOString().split("T")[0];
        const isT = d.toDateString() === now.toDateString();
        const n = schedule.filter(s => s.date === iso).length;
        return `<div onclick="scrollToDay('${iso}')" style="flex:1;text-align:center;padding:8px 1px;border-radius:10px;background:${isT ? "rgba(212,164,74,0.12)" : "var(--glass)"};border:${isT ? "2px" : "1px"} solid ${isT ? "var(--acc)" : "var(--glassB)"};cursor:pointer;min-width:0">
          <div style="font-size:7px;color:${isT ? "var(--acc)" : "var(--dm)"};font-family:var(--mono);font-weight:700;letter-spacing:.02em">${DN[d.getDay()].toUpperCase()}</div>
          <div style="font-size:16px;font-weight:800;color:${isT ? "var(--acc)" : "var(--ow)"};font-family:var(--mono);margin:3px 0">${d.getDate()}</div>
          ${n ? `<div style="width:5px;height:5px;border-radius:50%;background:var(--acc);margin:0 auto"></div>` : `<div style="height:5px"></div>`}
        </div>`;
      }).join("")}
    </div>

    ${days.map(d => {
      const iso = d.toISOString().split("T")[0];
      const ds = schedule.filter(s => s.date === iso).sort((a, b) => (a.time || "").localeCompare(b.time || ""));
      return `
        <div id="day-${iso}" style="margin-bottom:14px">
          <div style="font-size:10px;color:var(--dm);font-family:var(--mono);margin-bottom:6px">${DN[d.getDay()].toUpperCase()} Â· ${d.getMonth()+1}/${d.getDate()}</div>
          ${ds.length ? ds.map(s => {
            const isComplete = s.status === "complete";
            const isCancelled = s.status === "cancelled";
            return `<div class="cd" style="display:flex;align-items:center;gap:12px;border-left:3px solid ${isComplete ? "var(--success)" : isCancelled ? "var(--danger)" : "var(--acc)"}">
              <div style="min-width:48px;font-family:var(--mono);font-size:12px;font-weight:700;color:${isComplete ? "var(--success)" : "var(--acc)"}">${fmtTimeStr(s.time)}</div>
              <div style="flex:1">
                <div style="font-size:13px;font-weight:600;color:var(--wh)">${escHtml(s.clientName)}</div>
                <div style="font-size:10px;color:var(--dm)">${s.type || "Training"} Â· $${s.rate || 70}${isComplete ? ' Â· <span class="status-chip status-complete">DONE</span>' : isCancelled ? ' Â· <span class="status-chip status-cancelled">CANCELLED</span>' : ""}</div>
              </div>
              ${!isComplete && !isCancelled ? `
                <button class="btn2" onclick="completeScheduled('${s.id}')" style="padding:4px 8px;font-size:8px">LOG</button>
                <button class="btn2" onclick="push('edit',{schedId:'${s.id}'})" style="padding:4px 8px;font-size:8px">EDIT</button>
              ` : ""}
              <span style="font-size:13px;color:var(--danger);cursor:pointer;padding:4px 8px" onclick="deleteScheduled('${s.id}')">âœ•</span>
            </div>`;
          }).join("") : `<div style="padding:6px 0;font-size:10px;color:var(--dmL)">No sessions</div>`}
        </div>`;
    }).join("")}

    <div class="gw"></div>
    <div style="text-align:center"><button class="btn2" onclick="document.getElementById('schForm').style.display=document.getElementById('schForm').style.display==='none'?'block':'none'" style="padding:10px 24px">+ ADD TO SCHEDULE</button></div>
    <div id="schForm" style="display:${currentView.data.prefillClientId ? 'block' : 'none'};margin-top:12px">
    <div class="cd" style="padding:18px">
      <div class="field"><span class="lb">CLIENT *</span><select id="schC" onchange="onScheduleClientSelect()"><option value="">Select...</option>${clients.map(c => `<option value="${c.id}"${(currentView.data.prefillClientId === c.id) ? " selected" : ""}>${escHtml(c.name)}</option>`).join("")}</select></div>
      <div class="g2 field">
        <div><span class="lb">DATE</span><input id="schD" type="date" value="${todayISO()}"></div>
        <div><span class="lb">TIME</span><input id="schT" type="time" value="${getNextHourTime()}"></div>
      </div>
      <div class="g2 field">
        <div><span class="lb">TYPE</span><select id="schTy"><option>Training</option><option>Mobility</option><option>Training + Mobility</option><option>Assessment</option></select></div>
        <div><span class="lb">RATE ($)</span><input id="schR" type="number" value="70"></div>
      </div>
      <button class="btn" onclick="addToSchedule()">ADD TO SCHEDULE</button>
    </div>
    </div>`;
}

function renderScheduleEdit() {
  const sched = schedule.find(s => s.id === currentView.data.schedId);
  if (!sched) { pop(); return ""; }

  return `
    <button class="btn2" onclick="pop()" style="margin-bottom:14px">â€¹ Back</button>
    <div class="pt">Edit Scheduled Session</div>
    <div class="cd" style="padding:18px">
      <div class="field"><span class="lb">CLIENT</span><select id="schC">${clients.map(c => `<option value="${c.id}"${c.id === sched.clientId ? " selected" : ""}>${escHtml(c.name)}</option>`).join("")}</select></div>
      <div class="g2 field">
        <div><span class="lb">DATE</span><input id="schD" type="date" value="${sched.date}"></div>
        <div><span class="lb">TIME</span><input id="schT" type="time" value="${sched.time || "10:00"}"></div>
      </div>
      <div class="g2 field">
        <div><span class="lb">TYPE</span><select id="schTy">${["Training","Mobility","Training + Mobility","Assessment"].map(t => `<option${t === sched.type ? " selected" : ""}>${t}</option>`).join("")}</select></div>
        <div><span class="lb">RATE ($)</span><input id="schR" type="number" value="${sched.rate || 70}"></div>
      </div>
      <button class="btn" onclick="updateScheduled('${sched.id}')">SAVE CHANGES</button>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn-success" style="flex:1" onclick="completeScheduled('${sched.id}')">LOG SESSION</button>
        <button class="btn-danger" style="flex:1" onclick="cancelScheduled('${sched.id}')">CANCEL SESSION</button>
      </div>
    </div>`;
}

function getNextHourTime() {
  const now = new Date();
  const h = now.getHours() + 1;
  return (h < 10 ? "0" + h : h > 23 ? "08" : h) + ":00";
}

function onScheduleClientSelect() {
  const cId = v("schC");
  const c = clientById(cId);
  if (c) {
    const rateEl = $("schR");
    if (rateEl) rateEl.value = c.rate || "70";
    const typeEl = $("schTy");
    if (typeEl && c.type) {
      for (let i = 0; i < typeEl.options.length; i++) {
        if (typeEl.options[i].text === c.type) { typeEl.selectedIndex = i; break; }
      }
    }
  }
}

function scrollToDay(iso) {
  const el = document.getElementById("day-" + iso);
  if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
  // Also pre-fill the date in the add form
  const dateInput = $("schD");
  if (dateInput) dateInput.value = iso;
}

function addToSchedule() {
  const cId = v("schC");
  if (!cId) { toast("Select a client"); return; }
  const c = clientById(cId);
  schedule.push({
    id: Date.now().toString(),
    clientId: cId,
    clientName: c ? c.name : "",
    date: v("schD") || todayISO(),
    time: v("schT") || "10:00",
    type: v("schTy") || "Training",
    rate: v("schR") || (c ? c.rate : "70"),
    status: ""
  });
  save();
  toast("âœ“ Scheduled");
  render();
}

function updateScheduled(id) {
  const sched = schedule.find(s => s.id === id);
  if (!sched) return;
  const cId = v("schC");
  const c = clientById(cId);
  sched.clientId = cId;
  sched.clientName = c ? c.name : sched.clientName;
  sched.date = v("schD") || sched.date;
  sched.time = v("schT") || sched.time;
  sched.type = v("schTy") || sched.type;
  sched.rate = v("schR") || sched.rate;
  save();
  toast("âœ“ Updated");
  pop();
}

function deleteScheduled(id) {
  if (!confirm("Remove this scheduled session?")) return;
  schedule = schedule.filter(x => x.id !== id);
  save();
  toast("Removed");
  render();
}

function cancelScheduled(id) {
  const sched = schedule.find(s => s.id === id);
  if (!sched) return;
  sched.status = "cancelled";
  save();
  toast("Session cancelled");
  pop();
}

// === SETTINGS ===
function renderSettings() {
  const totalRev = sessions.filter(s => s.status !== "cancelled" && s.status !== "noshow").reduce((a, s) => a + parseFloat(s.rate || 0), 0);
  const gymOwed = Math.round(totalRev * getGymCut());

  return `
    <button class="btn2" onclick="go('home')" style="margin-bottom:12px">â€¹ BACK</button>
    <div class="pt">Settings</div>

    <div class="sl">SECURITY</div>
    <div class="cd" style="padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div><div style="font-size:13px;font-weight:600;color:var(--wh)">PIN Lock</div><div style="font-size:10px;color:var(--dm)">Protects client data from unauthorized access</div></div>
      </div>
      <div class="g2">
        <button class="btn2" onclick="changePIN()" style="width:100%">CHANGE PIN</button>
        <button class="btn2" onclick="sessionStorage.removeItem('regi_unlocked');location.reload()" style="width:100%">LOCK NOW</button>
      </div>
    </div>

    <div class="sl" style="margin-top:18px">DATA</div>
    <div class="cd" style="padding:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--borderS)">
        <span style="font-size:12px;color:var(--mu)">Clients</span>
        <span style="font-size:13px;font-weight:700;color:var(--wh);font-family:var(--mono)">${clients.length}</span>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--borderS)">
        <span style="font-size:12px;color:var(--mu)">Sessions Logged</span>
        <span style="font-size:13px;font-weight:700;color:var(--wh);font-family:var(--mono)">${sessions.length}</span>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--borderS)">
        <span style="font-size:12px;color:var(--mu)">Scheduled</span>
        <span style="font-size:13px;font-weight:700;color:var(--wh);font-family:var(--mono)">${schedule.filter(s => !s.status || s.status === "").length} upcoming</span>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--borderS)">
        <span style="font-size:12px;color:var(--mu)">All-Time Revenue</span>
        <span style="font-size:13px;font-weight:700;color:var(--accVib);font-family:var(--mono)">$${totalRev}</span>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0">
        <span style="font-size:12px;color:var(--mu)">All-Time Gym Cut</span>
        <span style="font-size:13px;font-weight:700;color:var(--dm);font-family:var(--mono)">$${gymOwed}</span>
      </div>
    </div>

    <div class="sl" style="margin-top:18px">BACKUP & RESTORE</div>
    <div class="cd" style="padding:16px">
      <div style="font-size:11px;color:var(--dm);margin-bottom:12px;line-height:1.5">Export all clients, sessions, and schedule data as a JSON file. Restore from a previous backup to recover data.</div>
      <div class="g2">
        <button class="btn2" onclick="exportData()" style="width:100%">EXPORT BACKUP</button>
        <button class="btn2" onclick="$('importFile').click()" style="width:100%">IMPORT BACKUP</button>
      </div>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    </div>

    <div class="sl" style="margin-top:18px">GYM SETTINGS</div>
    <div class="cd" style="padding:16px">
      <div class="field">
        <span class="lb">GYM CUT (%)</span>
        <div style="display:flex;gap:4px;flex-wrap:wrap">
          ${[10,15,20,25,30].map(p => `<div class="chip${Math.round(getGymCut()*100) === p ? " on" : ""}" onclick="setGymCut(${p})">${p}%</div>`).join("")}
        </div>
      </div>
      <div class="field">
        <span class="lb">DEFAULT SESSION RATE ($)</span>
        <input id="defRate" type="number" value="${LS.get('defaultRate', '70')}" onchange="LS.set('defaultRate',this.value)">
      </div>
    </div>

    <div class="sl" style="margin-top:18px">DANGER ZONE</div>
    <div class="cd" style="padding:16px;border:1px solid rgba(216,120,120,0.15)">
      <div style="font-size:11px;color:var(--danger);margin-bottom:12px;line-height:1.5">These actions cannot be undone. Export a backup first.</div>
      <div class="g2">
        <button class="btn-danger" onclick="clearAllSessions()">CLEAR SESSIONS</button>
        <button class="btn-danger" onclick="clearAllData()">RESET EVERYTHING</button>
      </div>
    </div>

    <div style="text-align:center;padding:20px 0;margin-top:12px">
      <div style="font-size:9px;color:var(--dmL);font-family:var(--mono);letter-spacing:0.08em">REGI COACHING STUDIO v${VERSION}</div>
      <div style="font-size:8px;color:var(--dmL);font-family:var(--mono);margin-top:4px">regi.fitness Â· Built by DK Fit Coaching Lab</div>
    </div>`;
}

function setGymCut(pct) {
  LS.set('gymCut', pct);
  toast("âœ“ Gym cut set to " + pct + "%");
  render();
}

function clearAllSessions() {
  if (!confirm("Delete ALL sessions? This cannot be undone.")) return;
  if (!confirm("Are you absolutely sure? This will permanently delete all session history.")) return;
  sessions = [];
  save();
  toast("All sessions cleared");
  render();
}

function clearAllData() {
  if (!confirm("RESET EVERYTHING? All clients, sessions, and schedule data will be permanently deleted.")) return;
  if (!confirm("Last chance â€” this will delete everything. Are you sure?")) return;
  clients = [];
  sessions = [];
  schedule = [];
  save();
  toast("All data cleared");
  render();
}

// === GUIDE ===
const GUIDE_DATA = [
{t:"MINDSET",items:[
{t:"You Are the Professional",d:"Clients seek trainers because they want guidance, accountability, or a starting point. By the time they book, the decision is already made. Confidence in your own preparation sets the tone for everything that follows."},
{t:"Their Doubt Is Not Yours to Carry",d:"Most clients arrive carrying some level of uncertainty about themselves. Acknowledge where they are, then redirect the conversation toward what they can do. Consistent belief in their potential â€” expressed through your coaching â€” is one of the most powerful tools available to you."},
{t:"Be the Highlight",d:"Consistency in your energy creates a reliable environment regardless of how the client shows up on any given day. For many people, this session is the only hour in their day that exists entirely for them. A successful session means they leave feeling better than when they walked in â€” physically and mentally."},
{t:"Let Them Talk",d:"Ask good questions, then listen. People will tell you everything you need to know if you give them space. Pain points, real goals, actual limitations â€” it all comes out naturally. You don't need every answer right away. You just need them to feel heard."},
{t:"Make the Small Wins Big",d:"The first time someone does something they didn't think they could, make it a moment. Be more excited about their progress than they are. That feeling is what keeps people coming back long before the physical results show up."},
{t:"Believe In Them â€” Or Don't Take Them",d:"Honest assessment builds trust faster than optimism. If a client's goals don't align with their available commitment, a direct conversation about that earns more respect than over-promising. Once you agree to work together, full investment from both sides is the expectation."},
{t:"You Live What You Teach",d:"You've competed. You've done the work. When a client looks at you they're not just seeing a trainer â€” they're seeing where they want to go. Let that be visible. Not arrogance â€” just presence."},
{t:"Start Before You Feel Ready",d:"Pre-session nerves are normal and fade with repetition. Preparation eliminates most uncertainty. Trust your training knowledge, stay present, and let each session build your pattern recognition."},
{t:"Motivation vs Discipline",d:"Most clients will come to you fueled by motivation â€” but motivation fades. Your job is to help them build discipline, which is a trainable skill. The prefrontal cortex controls executive function â€” decision-making, impulse control, delayed gratification. Every time a client follows through on something they didn't feel like doing, that neural pathway gets stronger. Explain this: discipline is literally a muscle in the brain. The more they use it, the easier it becomes. Small consistent actions compound. Five extra minutes of effort per week is still forward momentum. That's how people who stay in shape stay in shape â€” they've built habits that make the hard things feel automatic. The opposite is true for people stuck in bad patterns. Help them understand they're not broken â€” they're just rewiring years of reinforced habits, and that takes time and consistency, not perfection."},
{t:"Goal Setting & Momentum",d:"Most clients will have one big overwhelming goal. Break it down. A 50-pound fat loss goal is paralyzing â€” losing 2 pounds this week is actionable. Explain momentum: one good decision leads to the next. One good meal out of three is already a 33% improvement. Every small win stacks. Your job is to constantly search for gaps â€” areas where they can improve with minimal friction. Reframe goals around what they can control: 'What's your goal this week?' Not a weight number, but an action. Train 3 times. Drink a gallon of water daily. Cut out one junk meal. Replace, don't restrict. Meet them where they are and move them forward one step at a time."},
]},
{t:"PROSPECT & ONBOARDING",items:[
{t:"Free Consultation Call",d:"Schedule a free phone consultation â€” this is how you convert interest into commitment. Find out: where they're starting physically, what they want and why, any injuries or limitations, their availability, and when they want to begin. Listen more than you talk. If they're hesitant â€” offer a complimentary first session. Works almost every time. Never quote a price on the first call if you're not sure what they need yet. Say: 'Let's keep talking about it. Once I have a better idea of your goals and what kind of support you need, I can put something together that actually makes sense for you.'"},
{t:"Pricing",d:"Starting point: $1/min â€” $60 for 60 min. Adjust upward freely, no ceiling. They're not paying for an hour â€” they're paying for everything you've built to be able to give them that hour. Add-ons: meal plan $100â€“150, custom program $100â€“150. Options include: per session, weekly, monthly, or 3-month blocks. Any work done for a client outside the gym â€” programming, meal planning, check-ins â€” factor that into pricing. Ask what kind of check-ins they want: FaceTime, phone call, text. Do they want a full structured meal plan with adjustments, or just calorie and macro targets? The answer determines the scope of work and the price."},
{t:"Cancellation Policy",d:"24-hour cancellation policy â€” non-negotiable. If a client doesn't notify you at least 24 hours before their session, they are responsible for that session's cost. Either they forfeit a prepaid session or they owe for it. Make this crystal clear from day one â€” that's what prevents it from ever being an issue. Exceptions are yours to make: genuine illness, car trouble, real emergencies. Be reasonable but firm. If a client develops a pattern of late cancellations, address it directly. People who know you're lenient will unconsciously test it. A clear policy respects both your time and theirs."},
{t:"Payment",d:"Prefer cash. Venmo â€” have them send as a gift to avoid business fees. Run everything through a business account. Track deductibles: gas, clothes, equipment. Gym split: 20% of monthly earnings due within the first 5 days of the following month. Log every session consistently: date, client, amount charged."},
{t:"First Session Logistics",d:"Location: Old School Iron, Brook Park OH. Last door on the far right end of the building â€” meet at the front desk. Ask new clients to arrive 15 minutes early. Non-members sign the gym waiver on the iPad at front desk. Your 5 registered clients enter free."},
{t:"First Session Flow",d:"Walk them in, give a quick tour, keep the conversation going â€” you're still learning them. Re-confirm their goal, explain simply what you're going to do, then do it. From here the session blueprint takes over. Always end by telling them one specific thing they did well â€” something real, not generic praise. That's what they carry until next session."},
]},
{t:"SESSION BLUEPRINT",items:[
{t:"The Flow",d:"0â€“5 min: check-in â€” mood, soreness, anything new. 5â€“12 min: warm-up specific to the day. 12â€“15 min: pre-activation or pre-exhaustion (see Programming section). 15â€“45 min: main block â€” build from isolation to compound, volume to intensity. 45â€“55 min: mobility and stretching. 55â€“60 min: close out â€” one specific thing they did well and a preview of next session's focus."},
{t:"Warm-Up: Upper Days",d:"Use a 2.5â€“5 lb plate for front raises, lateral raises, and bent-over rear delt flyes. Add band rotations if available. This applies to any chest, shoulder, or full push day. Keep it under 5 minutes â€” the purpose is joint preparation and shoulder girdle activation, not fatigue. Light enough to feel the muscles waking up without approaching any real effort."},
{t:"Warm-Up: Lower Days",d:"Start with hip circles, leg swings, bodyweight squats, glute bridges, and banded abductions. A light RDL helps establish the hinge pattern early. For elderly clients or fat-loss-focused clients, the weighted sled is an excellent warm-up tool â€” reverse drags strengthen the tibialis anterior and are among the best knee-health movements available. Consider opening with calves for all clients. It promotes blood flow near the knee joint before heavier work, and it ensures calves receive full effort rather than being rushed at the end of the session."},
{t:"Warm-Up: Back Days",d:"Pullovers are highly effective for back pre-activation â€” cable, machine (Nautilus), or dumbbell variations all work. For clients who can perform pull-ups, supersetting them with pullovers creates an effective activation pairing. Whether pullovers serve as pre-activation (light, awareness-focused) or pre-exhaustion (working sets to fatigue the lats before compounds) depends on the client and the session objective."},
{t:"Main Block Structure",d:"Heavy compounds should not be the first working movement of the session. Build toward them through pre-activation or lighter lead-in sets. The main block progresses from targeted isolation into compound movements â€” not the reverse. Loading a compound pattern on a cold muscle group increases injury risk. Recommended structure: isolation or pre-exhaustion â†’ primary compound â†’ secondary compound or volume work â†’ finisher."},
{t:"Circuits & Giant Sets",d:"Circuits and giant sets are 2â€“4 exercises performed back-to-back with no rest between movements. Rest only after completing a full round. These are the best tool for clients primarily focused on fat loss, or for intensifying a session when the client is low energy â€” came in exhausted, didn't sleep, hasn't eaten. They keep the heart rate elevated and maximize caloric output without requiring heavy loads. Example: push sled â†’ dumbbell step-ups â†’ band pull-aparts â†’ bodyweight squats, rest 60â€“90 seconds, repeat 3 rounds."},
{t:"The Close",d:"End with one specific, concrete observation about something the client did well during the session. Reference a real moment â€” improved form on a particular lift, maintained tempo under fatigue, hit a new weight cleanly. Specificity makes the feedback meaningful. This is what they remember between sessions."},
{t:"Illness Rule",d:"General guideline: symptoms above the neck (congestion, mild headache) are typically fine to train through with modifications. Symptoms below the neck (fever, chest congestion, GI issues) warrant rescheduling. When in doubt, err on the side of rest."},
]},
{t:"PROGRAMMING",items:[
{t:"Rep Ranges by Goal",d:"Strength: 3â€“6 reps, 2â€“3 min rest. Hypertrophy: 6â€“12 reps, 60â€“90s rest. Endurance and conditioning: 12â€“20 reps, 30â€“45s rest. Fat loss circuits: 10â€“15 reps, 30â€“45s rest between rounds. Beginners: 8â€“12 reps with full recovery between sets. Form quality always takes priority over tempo."},
{t:"Starting Weight",d:"Take your initial estimate and cut it in half for the first working set. A lighter opener reveals movement mechanics and builds the client's confidence. Weight can always increase. The cost of starting too heavy far exceeds the cost of starting too light."},
{t:"Exercise Selection",d:"Not all compound movements are equal for every person. Pay attention to which movements a client connects with best â€” not the easiest ones, but the ones where they feel the target muscle working, where they report the most soreness, where their form is the most natural. Five exercises can all be technically correct for a muscle group, but one might be significantly better for that individual. Build their programming around movements they respond to. Ask them directly: which exercises do you feel the most? Start noticing patterns and let that guide your selection."},
{t:"Pre-Activation",d:"Light isolation before the compound movement. Intentionally easy â€” the goal is blood flow, mind-muscle connection, and awareness in the target area. Not meant to fatigue. Use with almost every client on almost every session. If a client can feel a muscle better, they'll get higher quality sets on the compound movements that follow. Example: light cable flyes before bench press, single-arm lat pulldowns before rows, leg extensions before squats."},
{t:"Pre-Exhaustion",d:"Working sets on isolation before the compound. This is intentional fatigue â€” you're making the target muscle the weak point in the chain so it's forced to do the work during the compound. Very effective for bodybuilding-style training, clients on a cut, anyone with chronic joint issues (reduces the load needed on compounds), and intermediate+ clients. Example: 3 working sets of leg extensions before squats â€” now the quads are pre-fatigued and they'll fail before the lower back gives out. Pair this with focused cues: control the tempo, be intentional behind every rep, don't just go through the motions."},
{t:"Progressive Overload",d:"Doesn't always mean more weight. In order: form quality â†’ full ROM â†’ reps (hit top of range) â†’ tempo (slower eccentric) â†’ volume (one more set) â†’ shorter rest â†’ load increase â†’ exercise complexity (machine â†’ dumbbell â†’ barbell over time). Progress when: form is clean, hitting top of rep range, RPE below 7."},
{t:"Intensifiers",d:"Drop set: fail â†’ drop 20% â†’ keep going. Rest-pause: fail â†’ 15â€“20s rest â†’ finish reps. Forced reps: assist the lift 2â€“3 reps past failure. Slow negative: 5â€“8 second eccentric at end of set. Read the client â€” if they're at their limit, back off. If they're holding back, push."},
{t:"Finisher Structure",d:"2â€“3 exercises, 2â€“3 rounds, ~10 reps each. Longer eccentrics, less load, more contraction focus. Elevates heart rate and burns more without grinding them down. Example chest finisher: hammer strength press â†’ machine fly â†’ incline push-up, drop to knees at failure."},
{t:"FST-7",d:"7 sets, 30â€“50 second rest (30s for smaller muscle groups, 45â€“50s for larger groups like quads or back), 10â€“20 reps, isolation only. For lagging or poorly activated muscle groups. Don't be rigid with the 7 sets â€” if the client can only do 4 or 5 with good form, start there and build up over weeks. Example: cable lateral raise lying back on an incline bench â€” removes trap involvement, isolates the lateral delt directly."},
{t:"Run the Rack",d:"Pick a rep count â€” 6, 8, or 10 depending on the client and the exercise. Start at the lightest weight with perfect form. Complete your reps with controlled negatives and full contraction at the top. Move up one increment. Continue until the target reps can't be completed with clean form, then work back down the rack. This works for any isolation movement â€” lateral raises, curls, leg extensions, cable work. For leg extensions: sets of 10, move up one plate on the stack each set. For lateral raises: 6 reps, pinky up at the top, stop just above the hip to maintain tension, move up one dumbbell. The principle is the same: fixed reps, ascending weight, descending when form breaks. Complete exhaustion of the target muscle."},
{t:"Sled Work",d:"The weighted sled is one of the most versatile tools in the gym. Reverse sled drags strengthen the tibialis anterior and are excellent for knee rehab and prevention â€” this should be a staple for any client with knee concerns or any elderly client. Sled pushes from the high handles are a good upper body and cardiovascular tool. Forward sled pulls (low harness or rope) are a full posterior chain builder. Use the sled as a warm-up, a finisher, or a circuit component depending on the client's goals. For fat loss clients, sled work can replace traditional cardio entirely."},
{t:"Triceps Rule",d:"Tricep isolation should follow movements that have already warmed the elbow joint â€” pressing work or light pushdowns. On arm-focused days, cable pushdowns are an effective opener. Key cue: full lockout with slight external rotation of the pinky at the bottom of each rep."},
]},
{t:"CLIENT PROFILES",items:[
{t:"Decision Framework",d:"For every client, work through these questions first: What is their stated goal? What is currently limiting them? What movements or activities are contraindicated? What alternatives exist? What does a successful session look like today? Approach each client with the same investment and attentiveness you would have wanted from a coach when you were starting out."},
{t:"Beginner",d:"Movement quality and comfort first â€” visible results are secondary during the first month. Stick to compound patterns until movement quality is consistent. Limit coaching cues to one or two per movement. RPE should stay at or below 7 early on. Starting weight: cut your initial estimate in half. Recommended defaults: goblet squat, RDL, dumbbell incline press, cable row, pallof press. Address nutrition early and directly â€” training supports results, but nutrition drives them. Framing this honestly from the beginning establishes credibility."},
{t:"Intermediate / Inconsistent",d:"These clients often have prior training experience without the results they expected. Visible, tracked week-over-week progress builds trust more effectively than words. Recommended split: push/pull/legs or upper/lower, minimum 3 sessions per week. Structure each session as: strength movement (6â€“8 reps) â†’ volume work (8â€“12 reps) â†’ circuit finisher. Introduce intensifiers around session 3 or 4."},
{t:"Advanced / Competitor",d:"Advanced clients typically seek a trainer for specificity, accountability, or a fresh perspective. Start by understanding their current programming and build from there. Identify lagging areas and prioritize them. Higher volume, shorter rest periods, and frequent use of intensifiers are appropriate at this level."},
{t:"Fat Loss Focus",d:"Diet is the primary driver â€” training is the accelerator. Start every conversation about goals with nutrition. Replace, don't restrict. Circuit training and sled work are your best tools for maximizing caloric expenditure in-session. Keep rest periods short, heart rate elevated. Consider structuring their entire session as circuits during the initial phase. Weigh-ins are fine but don't obsess â€” measurements, photos, and how clothes fit are better indicators."},
{t:"Elderly / Older Adult",d:"Everything connects to how they move in real life. Extended warm-up every time â€” never skip this. Start with sled work (reverse drags for knees, light pushes for blood flow) and calves. Build through hamstring curls, hip thrusts, and isolation work before any compound loading. Belt squats are the go-to compound for elderly clients â€” load the legs without loading the spine. Place compounds toward the end of the session after everything is warm and activated. Never start an elderly client on squats or leg extensions cold. Reduced ROM is acceptable. Machines and bands before free weights. Never rush rest periods. Connective tissue adapts slower than muscle â€” progress load slowly and patiently."},
{t:"Joint Injury / Post-Trauma",d:"Strengthen what surrounds the joint before loading it. Function before aesthetics. Knee example: reverse sled drags + TKEs + tibialis raises â†’ hamstring curls + hip thrusts â†’ single-leg balance work â†’ light leg extension â†’ wide-stance press (belt squat, leg press, goblet squat). Pain stops the set. Discomfort is workable â€” pain is not."},
{t:"Shoulder Limitation",d:"Avoid: overhead pressing, upright rows, wide-grip barbell, behind-the-neck anything. Keep: neutral grip pressing, cables, machine press, all rows. Mods: neutral grip DB press, landmine press, low cable fly, face pulls. Rotator cuff pre-activation before any pressing â€” every session."},
{t:"Back Pain / Spinal",d:"Avoid: spinal flexion under load, heavy conventional deadlifts, sit-ups. Keep: neutral spine hinge patterns, trap bar deadlift, leg press, most upper body, bird dogs, dead bugs, pallof press. Mods: RDL from rack height, trap bar over conventional, Bulgarian split squat, anti-rotation core only. Refer if: shooting pain down a limb, numbness, tingling."},
{t:"Neurological / Balance",d:"Stability first â€” stated goal is secondary until baseline is established. Bilateral movements before unilateral. TRX for assisted single-leg work. Slow tempos throughout. Balance is built by strengthening the muscles and stabilizers. Defaults: TRX single-leg squat, step-ups, single-arm cable row, pallof press, farmer's carry."},
]},
{t:"MOBILITY & STRETCHING",items:[
{t:"When to Address It First",d:"If a range of motion is significantly restricted, address it before loading that area. Training a stiff joint under load increases injury risk â€” this applies to any movement where tightness is visibly limiting the pattern."},
{t:"PNF Adjustments",d:"Push intensity matters â€” harder contraction gets a better response when a muscle is stubborn. Extend hold duration to 5â€“7 seconds for tight or imbalanced areas. Alternate sides each round, especially in session one â€” gives you a clear read on bilateral differences. If a stretch is felt in the wrong place, isolate that surrounding muscle first, then return."},
{t:"Before vs After Training",d:"Before: dynamic movement only â€” no prolonged static holds before lifting, it temporarily reduces force output. PNF is fine pre-session only when addressing a restriction that directly affects that day's movements. After: static stretching and PNF are both ideal â€” muscles are warm and receptive."},
{t:"Frequency",d:"Once every 7 days is the minimum to see consistent progress. 2â€“3x per week is the sweet spot. More than 3x rarely adds much. For imbalances: double the hold or add an extra round on the tighter side when they're working alone."},
]},
{t:"NUTRITION & SUPPLEMENTS",items:[
{t:"Diet Is the Foundation",d:"Nutrition is the primary driver of body composition results. Training amplifies and supports those results but cannot replace them. Communicating this directly and early establishes realistic expectations â€” most trainers avoid the conversation, so addressing it builds credibility. A practical starting point: one well-constructed meal per day that the client genuinely enjoys. One good meal out of three represents a 33% improvement. The approach should emphasize replacement over restriction â€” better choices should feel like additions, not losses."},
{t:"Hydration",d:"Muscle is roughly 80% water. Dehydrated muscle will underperform â€” strength, endurance, and recovery all suffer. Minimum: drink water before, during, and after every workout. Don't let clients train on empty â€” this alone improves session quality noticeably."},
{t:"Supplements",d:"Creatine monohydrate: 5g/day, the most well-researched performance supplement available. If bloating persists past the first week, switch to creatine HCl. Betaine: supports muscular endurance, underrated. Caffeine: improves output when used appropriately â€” not for everyone. Carbohydrates: the primary fuel source for training â€” don't let clients fear them."},
{t:"Pharmaceutical Questions",d:"These will come up. Keep it factual, brief, and neutral. Semaglutide (Ozempic/Wegovy): GLP-1 agonist, delays gastric emptying, reduces appetite. Tirzepatide (Mounjaro/Zepbound): dual GLP-1 + GIP agonist, stronger fat loss response than semaglutide. Anything beyond explaining what a medication is â€” not your lane."},
]},
{t:"BUSINESS & GROWTH",items:[
{t:"Professionalism",d:"Arriving before your client creates a fundamentally different experience than arriving after. Proactive communication â€” reaching out before they have to ask â€” is one of the fastest ways to build and maintain trust."},
{t:"Revenue Tracking",d:"Log every session: date, client, amount. 20% to the gym within the first 5 days of the following month. Run all income through a business account. Track deductibles â€” gas, clothes, equipment. Be consistent with what you log."},
{t:"Know Your Scope",d:"You're not a doctor, PT, or dietitian. Persistent pain, clinical nutrition, mental health concerns â€” acknowledge it, point them to the right person, keep training them. Being honest about your scope makes you more credible, not less. If you're not sure about an answer, say so. 'Let me look into that and get back to you' is always better than guessing."},
{t:"Client Referrals",d:"The number one growth strategy: pour everything into the clients you have. Results and experience create referrals organically. Once clients are comfortable and seeing progress, mention your referral system directly: 'For every person you refer who signs up, you get a free session.' Time it around natural momentum â€” a client hitting a milestone or expressing how good they feel is the perfect window. You can also run periodic referral campaigns: 'For the next two weeks, every referral that signs up earns you a free session.' Keep it simple, keep it direct."},
{t:"Online Coaching Upsell",d:"If a client's in-person schedule or budget is limited but their goals require more support, this is where online coaching fills the gap. Custom programming, macro guidance, weekly check-ins â€” these can all be delivered remotely. Explain the value: 'I can only control what happens in this hour, but your results depend on the other 167 hours in the week. Let me help you with those too.' Price based on scope â€” a simple macro calculation is different from a full meal plan with weekly adjustments and FaceTime check-ins."},
]},
];

let _guideSec = 0;

function renderGuide() {
  return `
    <div class="pt">Training Guide</div>
    <div style="font-size:12px;color:var(--mu);margin-bottom:16px;line-height:1.6">Quick-reference knowledge base. Tap a category, then tap any topic.</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px">${GUIDE_DATA.map((sec, si) => `<div class="chip${_guideSec === si ? " on" : ""}" onclick="showGuideSec(${si})" id="gNav${si}" style="padding:6px 12px">${sec.t}</div>`).join("")}</div>
    <div id="guideBody">${guideSecHTML(_guideSec)}</div>`;
}

function guideSecHTML(si) {
  const sec = GUIDE_DATA[si];
  if (!sec) return "";
  return sec.items.map((it, ii) => `
    <div class="cd" style="cursor:pointer" onclick="toggleGuideItem(${si},${ii})">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:13px;font-weight:600;color:var(--ow)">${it.t}</span>
        <span style="color:var(--dm);font-size:9px;transition:transform 0.2s" id="gia${si}_${ii}">â–¼</span>
      </div>
      <div id="git${si}_${ii}" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid var(--borderS);font-size:12px;color:var(--mu);line-height:1.85">${it.d}</div>
    </div>`).join("");
}

function showGuideSec(si) {
  _guideSec = si;
  GUIDE_DATA.forEach((_, i) => {
    const el = $("gNav" + i);
    if (el) el.className = "chip" + (i === si ? " on" : "");
  });
  const body = $("guideBody");
  if (body) body.innerHTML = guideSecHTML(si);
}

function toggleGuideItem(si, ii) {
  const el = $("git" + si + "_" + ii);
  const a = $("gia" + si + "_" + ii);
  if (el) {
    const show = el.style.display === "none";
    el.style.display = show ? "block" : "none";
    if (a) a.style.transform = show ? "rotate(180deg)" : "rotate(0)";
  }
}

// === PIN Lock System ===
// Simple client-side PIN to prevent casual access to client data
// Not military-grade auth but protects from random URL visitors
const PIN_KEY = "regi_pin";
const PIN_UNLOCKED_KEY = "regi_unlocked";
const DEFAULT_PIN = "1234"; // User should change this

function getPIN() { return localStorage.getItem(PIN_KEY) || DEFAULT_PIN; }
function setPIN(p) { localStorage.setItem(PIN_KEY, p); }
function isUnlocked() { return sessionStorage.getItem(PIN_UNLOCKED_KEY) === "true"; }
function unlock() { sessionStorage.setItem(PIN_UNLOCKED_KEY, "true"); }

function showLockScreen() {
  const app = $("app");
  app.style.display = "none";
  
  let lockDiv = $("lockScreen");
  if (!lockDiv) {
    lockDiv = document.createElement("div");
    lockDiv.id = "lockScreen";
    document.body.appendChild(lockDiv);
  }
  
  const hasCustomPIN = localStorage.getItem(PIN_KEY);
  
  lockDiv.style.cssText = "position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);padding:24px";
  lockDiv.innerHTML = `
    <div style="position:absolute;top:-80px;left:50%;transform:translateX(-50%);width:300px;height:300px;border-radius:50%;background:radial-gradient(circle,rgba(212,164,74,0.08),transparent 60%);pointer-events:none;filter:blur(30px)"></div>
    <div style="position:relative;display:flex;flex-direction:column;align-items:center">
      <div style="width:72px;height:72px;border-radius:18px;background:linear-gradient(135deg,#1a1610,#2e2418);border:1px solid var(--borderH);display:flex;align-items:center;justify-content:center;font-family:var(--display);font-size:34px;font-weight:900;color:var(--acc);box-shadow:0 0 50px var(--accGlow);animation:breathe 4s ease-in-out infinite;margin-bottom:28px">R</div>
      <div style="font-family:var(--display);font-size:22px;font-weight:700;letter-spacing:0.1em;color:var(--ice);margin-bottom:4px">REGI</div>
      <div style="font-size:9px;color:var(--dm);font-family:var(--mono);letter-spacing:0.18em;margin-bottom:40px">COACHING STUDIO</div>
      <div style="width:100%;max-width:240px">
        <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" maxlength="8" placeholder="Â· Â· Â· Â·" style="text-align:center;font-size:20px;letter-spacing:0.4em;font-family:var(--mono);padding:14px;margin-bottom:14px;border-radius:10px">
        <button class="btn" onclick="tryUnlock()" style="margin-bottom:10px;border-radius:10px">UNLOCK</button>
        <div id="pinError" style="text-align:center;font-size:10px;color:var(--danger);font-family:var(--mono);min-height:18px"></div>
      </div>
      ${!hasCustomPIN ? '<div style="margin-top:32px;font-size:9px;color:var(--dmL);font-family:var(--mono);letter-spacing:0.06em;opacity:0.5">First time? PIN is 1234</div>' : ''}
    </div>`;
  
  setTimeout(() => {
    const inp = $("pinInput");
    if (inp) {
      inp.focus();
      inp.addEventListener("keydown", (e) => { if (e.key === "Enter") tryUnlock(); });
    }
  }, 100);
}

function tryUnlock() {
  const inp = $("pinInput");
  const entered = inp ? inp.value.trim() : "";
  if (entered === getPIN()) {
    unlock();
    const lock = $("lockScreen");
    if (lock) lock.remove();
    const app = $("app");
    app.style.display = "";
    render();
  } else {
    const err = $("pinError");
    if (err) err.textContent = "Incorrect PIN";
    if (inp) { inp.value = ""; inp.focus(); }
  }
}

// Change PIN function (accessible from guide or settings)
function changePIN() {
  const current = prompt("Enter current PIN:");
  if (current !== getPIN()) { toast("Incorrect PIN"); return; }
  const newPin = prompt("Enter new PIN (4-8 digits):");
  if (!newPin || newPin.length < 4 || !/^\d+$/.test(newPin)) { toast("PIN must be 4-8 digits"); return; }
  const confirm2 = prompt("Confirm new PIN:");
  if (confirm2 !== newPin) { toast("PINs don't match"); return; }
  setPIN(newPin);
  toast("âœ“ PIN updated");
}

// === Initial render ===
if (!isUnlocked()) {
  showLockScreen();
} else {
  try {
    $("app").style.display = "";
    render();
  } catch(e) {
    document.body.innerHTML = '<div style="padding:20px;color:red;font-family:monospace;font-size:14px">RENDER ERROR: ' + e.message + '<br><br>Stack: ' + e.stack + '</div>';
  }
}

// === PWA install prompt ===
let _deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  _deferredPrompt = e;
  const b = document.createElement('div');
  b.id = 'installBanner';
  b.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#1a1610,#2e2418);border:1px solid var(--accB);border-radius:12px;padding:14px 20px;display:flex;align-items:center;gap:14px;z-index:99;box-shadow:0 8px 32px rgba(0,0,0,0.4);max-width:320px;width:90%';
  b.innerHTML = `<div style="width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accDeep),var(--accD));display:flex;align-items:center;justify-content:center;font-family:var(--display);font-size:18px;font-weight:900;color:var(--ice);flex-shrink:0">R</div><div style="flex:1"><div style="font-size:12px;font-weight:700;color:var(--ice);font-family:var(--mono)">INSTALL APP</div><div style="font-size:10px;color:var(--mu);margin-top:2px">Add REGI to your home screen</div></div><button onclick="installApp()" style="background:linear-gradient(135deg,var(--accDeep),var(--accD));color:var(--ice);font-family:var(--mono);font-size:9px;font-weight:700;padding:7px 12px;border-radius:6px;border:none;cursor:pointer;letter-spacing:0.08em">ADD</button><span onclick="document.getElementById('installBanner').remove()" style="color:var(--dm);cursor:pointer;font-size:16px;padding:2px 4px">âœ•</span>`;
  document.body.appendChild(b);
});

function installApp() {
  if (_deferredPrompt) {
    _deferredPrompt.prompt();
    _deferredPrompt.userChoice.then(() => {
      _deferredPrompt = null;
      const b = document.getElementById('installBanner');
      if (b) b.remove();
    });
  }
}

// Service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
